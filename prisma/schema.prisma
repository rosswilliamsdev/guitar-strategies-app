generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  token String @unique
  expires DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  password          String?
  passwordResetTokens PasswordResetToken[]
  name              String
  role              Role               @default(STUDENT)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  accounts          Account[]
  emailPreferences  EmailPreference[]
  sessions          Session[]
  createdChecklists StudentChecklist[]
  studentProfile    StudentProfile?
  teacherProfile    TeacherProfile?

  @@index([email])
  @@index([role])
}

model TeacherProfile {
  id              String                 @id @default(cuid())
  userId          String                 @unique
  bio             String?
  hourlyRate      Int?
  isActive        Boolean                @default(true)
  venmoHandle     String?
  paypalEmail     String?
  zelleEmail      String?
  timezone        String                 @default("America/New_York")
  phoneNumber     String?
  profileImageUrl String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  isAdmin         Boolean                @default(false)
  curriculums     Curriculum[]
  invoices        Invoice[]
  lessons         Lesson[]
  libraryItems    LibraryItem[]
  monthlyBilling  MonthlyBilling[]       @relation("TeacherBilling")
  recommendations Recommendation[]
  recurringSlots  RecurringSlot[]        @relation("TeacherSlots")
  students        StudentProfile[]       @relation("TeacherStudents")
  availability    TeacherAvailability[]
  blockedTimes    TeacherBlockedTime[]
  lessonSettings  TeacherLessonSettings?
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model StudentProfile {
  id                    String                      @id @default(cuid())
  userId                String                      @unique
  teacherId             String
  joinedAt              DateTime                    @default(now())
  goals                 String?
  instrument            String                      @default("guitar")
  phoneNumber           String?
  parentEmail           String?
  emergencyContact      String?
  isActive              Boolean                     @default(true)
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  emailOnInvoice        Boolean                     @default(true)
  emailOnLessonComplete Boolean                     @default(true)
  emailOnLessonReminder Boolean                     @default(true)
  invoices              Invoice[]
  lessons               Lesson[]
  monthlyBilling        MonthlyBilling[]            @relation("StudentBilling")
  recurringSlots        RecurringSlot[]             @relation("StudentSlots")
  slotSubscriptions     SlotSubscription[]          @relation("StudentSubscriptions")
  studentChecklists     StudentChecklist[]
  studentProgress       StudentCurriculumProgress[]
  teacher               TeacherProfile              @relation("TeacherStudents", fields: [teacherId], references: [id], onDelete: Cascade)
  user                  User                        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([teacherId])
  @@index([isActive])
}

model Lesson {
  id              String             @id @default(cuid())
  teacherId       String
  studentId       String
  date            DateTime
  duration        Int
  notes           String?
  homework        String?
  progress        String?
  status          LessonStatus       @default(SCHEDULED)
  focusAreas      String?
  songsPracticed  String?
  nextSteps       String?
  studentRating   Int?
  teacherRating   Int?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  isRecurring     Boolean            @default(false)
  price           Int                @default(0)
  recurringId     String?
  recurringSlotId String?
  timezone        String             @default("America/New_York")
  checklistItems  String?
  version         Int                @default(1)
  invoiceItems    InvoiceItem[]
  recurringSlot   RecurringSlot?     @relation("SlotLessons", fields: [recurringSlotId], references: [id])
  student         StudentProfile     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher         TeacherProfile     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  attachments     LessonAttachment[]
  links           LessonLink[]

  @@index([teacherId, date])
  @@index([studentId, date])
  @@index([status])
  @@index([date])
  @@index([recurringId])
  @@index([recurringSlotId])
}

model LessonAttachment {
  id           String   @id @default(cuid())
  lessonId     String
  fileName     String
  originalName String
  fileSize     Int
  mimeType     String
  fileUrl      String
  uploadedAt   DateTime @default(now())
  lesson       Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model LessonLink {
  id          String   @id @default(cuid())
  lessonId    String
  title       String
  url         String
  description String?
  linkType    LinkType @default(WEBSITE)
  createdAt   DateTime @default(now())
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model LibraryItem {
  id            String           @id @default(cuid())
  title         String
  description   String?
  fileUrl       String
  fileName      String
  fileSize      Int
  teacherId     String
  isPublic      Boolean          @default(false)
  category      LibraryCategory? @default(TABLATURE)
  tags          String?
  downloadCount Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  instrument    Instrument       @default(GUITAR)
  teacher       TeacherProfile   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([isPublic])
  @@index([instrument])
  @@index([category])
}

model Recommendation {
  id          String                 @id @default(cuid())
  title       String
  description String
  link        String?
  category    RecommendationCategory
  teacherId   String
  price       String?
  priority    Int                    @default(1)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  teacher     TeacherProfile         @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([category])
}

model Invoice {
  id             String          @id @default(cuid())
  teacherId      String
  studentId      String?
  invoiceNumber  String
  month          String
  dueDate        DateTime
  status         InvoiceStatus   @default(PENDING)
  subtotal       Int
  total          Int
  paidAt         DateTime?
  paymentMethod  String?
  paymentNotes   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  customEmail    String?
  customFullName String?
  student        StudentProfile? @relation(fields: [studentId], references: [id])
  teacher        TeacherProfile  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  items          InvoiceItem[]

  @@index([teacherId, month])
  @@index([studentId, month])
  @@index([status])
  @@index([dueDate])
}

model InvoiceItem {
  id          String    @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int       @default(1)
  rate        Int
  amount      Int
  lessonDate  DateTime?
  lessonId    String?
  createdAt   DateTime  @default(now())
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  lesson      Lesson?   @relation(fields: [lessonId], references: [id])

  @@index([invoiceId])
  @@index([lessonId])
}

model Curriculum {
  id              String                      @id @default(cuid())
  teacherId       String
  title           String
  description     String?
  isActive        Boolean                     @default(true)
  isPublished     Boolean                     @default(false)
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
  teacher         TeacherProfile              @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  sections        CurriculumSection[]
  studentProgress StudentCurriculumProgress[]

  @@index([teacherId])
  @@index([isPublished])
}

model CurriculumSection {
  id           String              @id @default(cuid())
  curriculumId String
  title        String
  description  String?
  category     CurriculumCategory?
  sortOrder    Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  items        CurriculumItem[]
  curriculum   Curriculum          @relation(fields: [curriculumId], references: [id], onDelete: Cascade)

  @@index([curriculumId])
  @@index([sortOrder])
}

model CurriculumItem {
  id               String                @id @default(cuid())
  sectionId        String
  title            String
  description      String?
  sortOrder        Int                   @default(0)
  difficulty       Int?
  estimatedMinutes Int?
  resourceUrl      String?
  notes            String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  section          CurriculumSection     @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  progress         StudentItemProgress[]

  @@index([sectionId])
  @@index([sortOrder])
}

model StudentCurriculumProgress {
  id              String                @id @default(cuid())
  studentId       String
  curriculumId    String
  startedAt       DateTime              @default(now())
  completedAt     DateTime?
  totalItems      Int                   @default(0)
  completedItems  Int                   @default(0)
  progressPercent Float                 @default(0)
  updatedAt       DateTime              @updatedAt
  curriculum      Curriculum            @relation(fields: [curriculumId], references: [id], onDelete: Cascade)
  student         StudentProfile        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  itemProgress    StudentItemProgress[]

  @@unique([studentId, curriculumId])
  @@index([studentId])
  @@index([curriculumId])
}

model StudentItemProgress {
  id                   String                    @id @default(cuid())
  curriculumProgressId String
  itemId               String
  status               ProgressStatus            @default(NOT_STARTED)
  startedAt            DateTime?
  completedAt          DateTime?
  teacherNotes         String?
  studentNotes         String?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  curriculumProgress   StudentCurriculumProgress @relation(fields: [curriculumProgressId], references: [id], onDelete: Cascade)
  item                 CurriculumItem            @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([curriculumProgressId, itemId])
  @@index([curriculumProgressId])
  @@index([itemId])
  @@index([status])
}

model StudentChecklist {
  id            String                 @id @default(cuid())
  studentId     String
  title         String
  isActive      Boolean                @default(true)
  isArchived    Boolean                @default(false)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  createdBy     String?
  createdByRole String?
  creator       User?                  @relation(fields: [createdBy], references: [id])
  student       StudentProfile         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  items         StudentChecklistItem[]

  @@index([studentId])
  @@index([isActive])
  @@index([createdBy])
}

model StudentChecklistItem {
  id               String           @id @default(cuid())
  checklistId      String
  title            String
  description      String?
  isCompleted      Boolean          @default(false)
  completedAt      DateTime?
  dueDate          DateTime?
  notes            String?
  resourceUrl      String?
  estimatedMinutes Int?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  sortOrder        Int              @default(0)
  checklist        StudentChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@index([checklistId])
  @@index([isCompleted])
  @@index([checklistId, sortOrder])
}

model TeacherLessonSettings {
  id                 String         @id @default(cuid())
  teacherId          String         @unique
  allows30Min        Boolean        @default(true)
  allows60Min        Boolean        @default(true)
  price30Min         Int
  price60Min         Int
  advanceBookingDays Int            @default(21)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  teacher            TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
}

model TeacherAvailability {
  id        String         @id @default(cuid())
  teacherId String
  dayOfWeek Int
  startTime String
  endTime   String
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  version   Int            @default(1)
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, dayOfWeek, startTime, endTime])
  @@index([teacherId])
  @@index([dayOfWeek])
}

model TeacherBlockedTime {
  id        String         @id @default(cuid())
  teacherId String
  startTime DateTime
  endTime   DateTime
  reason    String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([startTime, endTime])
}

model RecurringSlot {
  id             String             @id @default(cuid())
  teacherId      String
  studentId      String
  dayOfWeek      Int
  startTime      String
  duration       Int
  status         SlotStatus         @default(ACTIVE)
  bookedAt       DateTime           @default(now())
  cancelledAt    DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  perLessonPrice Int
  version        Int                @default(1)
  lessons        Lesson[]           @relation("SlotLessons")
  student        StudentProfile     @relation("StudentSlots", fields: [studentId], references: [id], onDelete: Cascade)
  teacher        TeacherProfile     @relation("TeacherSlots", fields: [teacherId], references: [id], onDelete: Cascade)
  subscriptions  SlotSubscription[]

  @@unique([teacherId, dayOfWeek, startTime, duration, status])
  @@index([teacherId, status])
  @@index([studentId, status])
  @@index([dayOfWeek])
}

model SlotSubscription {
  id              String             @id @default(cuid())
  slotId          String
  studentId       String
  startMonth      String
  endMonth        String?
  monthlyRate     Int
  status          SubscriptionStatus @default(ACTIVE)
  lastBilledMonth String?
  nextBillDate    DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  billingRecords  MonthlyBilling[]
  slot            RecurringSlot      @relation(fields: [slotId], references: [id], onDelete: Cascade)
  student         StudentProfile     @relation("StudentSubscriptions", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([slotId, studentId, startMonth])
  @@index([status])
  @@index([nextBillDate])
  @@index([studentId])
}

model MonthlyBilling {
  id              String           @id @default(cuid())
  subscriptionId  String
  studentId       String
  teacherId       String
  month           String
  expectedLessons Int
  actualLessons   Int              @default(0)
  ratePerLesson   Int
  totalAmount     Int
  status          BillingStatus    @default(PENDING)
  billedAt        DateTime?
  paidAt          DateTime?
  paymentMethod   String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  student         StudentProfile   @relation("StudentBilling", fields: [studentId], references: [id])
  subscription    SlotSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  teacher         TeacherProfile   @relation("TeacherBilling", fields: [teacherId], references: [id])

  @@unique([subscriptionId, month])
  @@index([month])
  @@index([status])
  @@index([studentId, month])
  @@index([teacherId, month])
}

model SystemSettings {
  id                         String   @id @default("system")
  platformFeePercentage      Float    @default(10.0)
  maxFileSize                Int      @default(10485760)
  allowedFileTypes           String   @default("pdf,doc,docx,jpg,png")
  paymentsEnabled            Boolean  @default(true)
  libraryEnabled             Boolean  @default(true)
  recommendationsEnabled     Boolean  @default(true)
  updatedAt                  DateTime @updatedAt
  cancellationPolicyText     String   @default("Please cancel at least 2 hours in advance to avoid charges.")
  defaultAdvanceBookingDays  Int      @default(14)
  defaultInvoiceDueDays      Int      @default(14)
  defaultLessonDuration30    Boolean  @default(true)
  defaultLessonDuration60    Boolean  @default(true)
  emailFooterText            String   @default("Thank you for choosing Guitar Strategies!")
  emailSenderAddress         String   @default("onboarding@resend.dev")
  emailSenderName            String   @default("Guitar Strategies")
  enableBookingConfirmations Boolean  @default(true)
  enableInvoiceNotifications Boolean  @default(true)
  enableReminderEmails       Boolean  @default(true)
  invoiceNumberFormat        String   @default("INV-{YEAR}-{NUMBER}")
  latePaymentReminderDays    Int      @default(7)
}

model EmailPreference {
  id        String    @id @default(cuid())
  userId    String
  enabled   Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  type      EmailType
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
}

model EmailTemplate {
  id          String    @id @default(cuid())
  type        EmailType @unique
  subject     String
  htmlBody    String
  variables   String
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([type])
  @@index([isActive])
}

model BackgroundJobLog {
  id                String   @id @default(cuid())
  jobName           String
  executedAt        DateTime @default(now())
  success           Boolean
  lessonsGenerated  Int      @default(0)
  teachersProcessed Int      @default(0)
  errors            String?

  @@index([jobName, executedAt])
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum LessonStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  MISSED
  NO_SHOW
}

enum RecommendationCategory {
  GEAR
  BOOKS
  SOFTWARE
  ONLINE_COURSES
  APPS
  OTHER
}

enum InvoiceStatus {
  PENDING
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

enum LibraryCategory {
  TABLATURE
  SHEET_MUSIC
  CHORD_CHARTS
  SCALES
  ETUDES
  EXERCISES
  THEORY
  OTHER
}

enum Instrument {
  GUITAR
  BASS
  UKULELE
}

enum LinkType {
  WEBSITE
  YOUTUBE
  VIMEO
  SPOTIFY
  OTHER
}

enum CurriculumCategory {
  CHORDS
  SCALES
  ARPEGGIOS
  THEORY
  RHYTHM
  LEAD_GUITAR
  FINGERSTYLE
  SONGS
  RIFFS
  SOLOS
  TECHNIQUE
  SIGHT_READING
  EAR_TRAINING
  IMPROVISATION
  OTHER
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  NEEDS_REVIEW
}

enum SlotStatus {
  ACTIVE
  CANCELLED
  SUSPENDED
  EXPIRED
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum BillingStatus {
  PENDING
  BILLED
  PAID
  OVERDUE
  CANCELLED
}

enum EmailType {
  LESSON_BOOKING
  LESSON_CANCELLATION
  LESSON_REMINDER
  INVOICE_GENERATED
  INVOICE_OVERDUE
  CHECKLIST_COMPLETION
  SYSTEM_UPDATES
  STUDENT_WELCOME
  LESSON_COMPLETED
}
